<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gama Brasil | Dashboard Estadual</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- Leaflet -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>

    <!-- GridStack -->
    <link href="https://cdn.jsdelivr.net/npm/gridstack@8.2.1/dist/gridstack.min.css" rel="stylesheet"/>
    <script src="https://cdn.jsdelivr.net/npm/gridstack@8.2.1/dist/gridstack-all.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&family=JetBrains+Mono:wght@400;700&display=swap');
        
        :root {
            --color-bg: #0f172a;
            --color-panel: #1e293b;
            --color-border: #334155;
            --theme-primary: #10b981; 
            --theme-secondary: #facc15; 
            --theme-text: #f8fafc;
            --theme-text-muted: #94a3b8;
        }

        body { 
            font-family: 'Inter', sans-serif; 
            background-color: var(--color-bg); 
            color: var(--theme-text); 
            overflow: hidden; 
            height: 100vh;
            display: flex;
            flex-direction: column;
        }
        
        .font-mono { font-family: 'JetBrains Mono', monospace; }

        .grid-stack { flex-grow: 1; overflow-y: auto; overflow-x: hidden; padding: 10px; background: var(--color-bg); }
        .grid-stack-item-content {
            background: var(--color-panel); border: 1px solid var(--color-border);
            border-radius: 8px; display: flex; flex-direction: column; overflow: hidden;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            position: absolute; inset: 0; transition: border-color 0.3s ease;
        }

        .panel-header {
            background: rgba(0,0,0,0.15); border-bottom: 1px solid var(--color-border);
            padding: 0.5rem 1rem; font-size: 0.75rem; font-weight: 600; color: var(--theme-text);
            display: flex; justify-content: space-between; align-items: center; text-transform: uppercase;
            letter-spacing: 0.05em; cursor: grab; flex-shrink: 0; z-index: 20;
            user-select: none; touch-action: none;
        }
        .panel-header:active { cursor: grabbing; }
        .panel-header i { color: var(--theme-secondary); transition: color 0.3s; pointer-events: none; }
        .panel-header button { pointer-events: auto; }
        .panel-header button i { pointer-events: none; }
        
        .grid-stack-item-content:hover { border-color: var(--theme-primary); }

        .widget-body { padding: 1rem; flex-grow: 1; display: flex; flex-direction: column; overflow: hidden; }
        
        .scrollable { overflow-y: auto !important; overflow-x: hidden; scrollbar-width: thin; scrollbar-color: var(--color-border) transparent; }
        .scrollable::-webkit-scrollbar { width: 6px; }
        .scrollable::-webkit-scrollbar-thumb { background: var(--color-border); border-radius: 3px; }

        select {
            appearance: none; background: #0f172a; border: 1px solid var(--color-border);
            color: var(--theme-text); padding: 0.3rem 2rem 0.3rem 0.75rem; border-radius: 4px; 
            font-size: 0.85rem; font-weight: 500; cursor: pointer; outline: none; transition: border-color 0.2s;
            max-width: 250px; text-overflow: ellipsis; white-space: nowrap;
        }
        select:focus { border-color: var(--theme-primary); }
        
        .data-value { font-size: 1.5rem; font-weight: 700; color: var(--theme-text); line-height: 1.2; }
        .data-label { font-size: 0.7rem; text-transform: uppercase; color: var(--theme-text-muted); font-weight: 500; }

        .chart-container { position: relative; height: 100%; width: 100%; min-height: 0; flex-grow: 1; display: flex; align-items: center; justify-content: center;}
        
        #mapContainer { position: relative; width: 100%; height: 100%; flex-grow: 1; }
        #map { position: absolute; inset: 0; z-index: 1; background: #e5e7eb; } /* Fundo claro para o mapa */

        /* Estilo para mapa Leaflet GeoJSON - Foco no contorno */
        .state-polygon { transition: fill-opacity 0.3s, stroke-width 0.3s, stroke 0.3s; cursor: pointer; }
        .state-polygon:hover { fill-opacity: 0.15 !important; stroke-width: 3px !important; }

        .wiki-link { cursor: pointer; transition: color 0.2s; position: relative; display: inline-block; }
        .wiki-link::after { content: ''; position: absolute; width: 100%; transform: scaleX(0); height: 1px; bottom: 0; left: 0; background-color: var(--theme-secondary); transform-origin: bottom right; transition: transform 0.25s ease-out; }
        .wiki-link:hover::after { transform: scaleX(1); transform-origin: bottom left; }
        .wiki-link:hover { color: var(--theme-secondary); }

        .modal-overlay { background: rgba(0,0,0,0.7); backdrop-filter: blur(4px); }
        .toast-enter { transform: translateY(100%); opacity: 0; }
        .toast-active { transform: translateY(0); opacity: 1; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        .error-state { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; color: var(--theme-text-muted); text-align: center; gap: 0.5rem; }
        
        .log-entry { padding-bottom: 4px; margin-bottom: 4px; border-bottom: 1px solid rgba(255,255,255,0.05); }
        .log-time { color: #64748b; margin-right: 4px; }
        .log-module { color: #94a3b8; font-weight: bold; margin-right: 4px; }
    </style>
</head>
<body>

    <header class="bg-slate-900 border-b border-slate-800 py-3 px-6 flex justify-between items-center z-50 shrink-0 shadow-md">
        <div class="flex items-center gap-3">
            <i class="fa-solid fa-map-location-dot text-2xl" style="color: var(--theme-primary)"></i>
            <div>
                <h1 class="text-xl font-bold tracking-wide text-white leading-none">GAMA BRASIL</h1>
                <div class="text-xs text-slate-400 mt-1">DASHBOARD DE MONITORAMENTO ESTADUAL</div>
            </div>
        </div>
        
        <div class="flex items-center gap-6">
            <button id="resetLayoutBtn" class="text-xs font-medium text-slate-300 hover:text-white border border-slate-700 hover:border-slate-500 rounded px-3 py-1.5 bg-slate-800 transition-colors flex items-center gap-2">
                <i class="fa-solid fa-arrows-rotate"></i> Resetar Layout
            </button>
            <div class="flex items-center gap-2">
                <span class="text-xs text-slate-400 uppercase font-semibold">Estado:</span>
                <div class="relative">
                    <select id="stateSelector" class="uppercase">
                        <option value="SP">CARREGANDO...</option>
                    </select>
                    <i class="fa-solid fa-chevron-down absolute right-3 top-1/2 transform -translate-y-1/2 text-slate-400 pointer-events-none text-xs"></i>
                </div>
            </div>
            
            <div class="text-right border-l border-slate-700 pl-4">
                <div id="localClock" class="text-white text-lg font-mono font-bold">00:00:00</div>
                <div id="timezoneLabel" class="text-[10px] text-slate-400 font-mono uppercase">HORÁRIO LOCAL</div>
            </div>
        </div>
    </header>

    <div class="grid-stack" id="mainGrid">
        
        <!-- Identidade -->
        <div class="grid-stack-item" gs-id="p-identity" gs-x="0" gs-y="0" gs-w="3" gs-h="3" gs-min-w="2" gs-min-h="3">
            <div class="grid-stack-item-content">
                <div class="panel-header">
                    <span><i class="fa-solid fa-id-card mr-2"></i>Identidade Estadual</span>
                    <span id="ufCode" class="font-mono font-bold">--</span>
                </div>
                <div class="widget-body scrollable flex-col justify-center gap-4">
                    <div class="flex items-center gap-4">
                        <img id="flagImg" src="" alt="Bandeira" class="w-16 h-auto object-cover border border-slate-700 rounded shadow-sm hidden" crossorigin="anonymous">
                        <div>
                            <div id="stateName" class="text-lg font-bold uppercase tracking-wide line-clamp-1 wiki-link" title="Ver na Wikipedia">Aguardando...</div>
                            <div class="text-sm font-medium mt-0.5">
                                <span class="text-slate-400 text-[10px] uppercase">Capital: </span>
                                <span id="stateCapital" class="wiki-link" title="Ver na Wikipedia">--</span>
                            </div>
                        </div>
                    </div>
                    <div class="grid grid-cols-2 gap-4 border-t border-slate-700 pt-3">
                        <div>
                            <div class="data-label">Governador(a)</div>
                            <div id="governorName" class="text-sm font-medium mt-1 truncate wiki-link" title="Ver na Wikipedia">--</div>
                        </div>
                        <div>
                            <div class="data-label">População (IBGE)</div>
                            <div id="population" class="text-sm font-mono font-bold mt-1">--</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Clima -->
        <div class="grid-stack-item" gs-id="p-climate" gs-x="0" gs-y="3" gs-w="3" gs-h="2" gs-min-w="2" gs-min-h="2">
            <div class="grid-stack-item-content">
                <div class="panel-header">
                    <span><i class="fa-solid fa-cloud-sun mr-2"></i>Clima na Capital</span>
                </div>
                <div class="widget-body justify-center" id="climateWidget">
                    <div class="flex flex-col items-center text-center gap-2">
                        <div class="text-5xl" id="weatherIcon"><i class="fa-solid fa-spinner fa-spin text-slate-600"></i></div>
                        <div id="temperature" class="text-4xl font-bold tracking-tighter mt-2">--°C</div>
                        <div id="weatherDesc" class="text-sm text-slate-400 capitalize">Processando...</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Alertas Ambientais estáticos -->
        <div class="grid-stack-item" gs-id="p-alerts" gs-x="0" gs-y="5" gs-w="3" gs-h="4" gs-min-w="2" gs-min-h="3">
            <div class="grid-stack-item-content">
                <div class="panel-header">
                    <span><i class="fa-solid fa-triangle-exclamation mr-2"></i>Status Climático</span>
                </div>
                <div class="flex flex-col flex-grow overflow-hidden">
                    <div class="flex text-[10px] font-semibold text-slate-400 uppercase border-b border-slate-700 py-2 px-3 shrink-0 bg-slate-800/50">
                        <div class="flex-grow">Boletim Meteorológico Geral</div>
                    </div>
                    <div id="alertsFeed" class="flex-grow scrollable flex flex-col p-1 gap-1">
                        <div class="p-4 text-center text-xs text-slate-400 font-mono mt-4">
                            <i class="fa-solid fa-tower-broadcast text-slate-500 text-2xl mb-3 block"></i>
                            Acompanhamento regional ativo.<br>Nenhum evento extremo reportado na API no momento.
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Logs do Sistema -->
        <div class="grid-stack-item" gs-id="p-system" gs-x="0" gs-y="9" gs-w="3" gs-h="2" gs-min-w="2" gs-min-h="2">
            <div class="grid-stack-item-content">
                <div class="panel-header !bg-slate-900 border-b-slate-950 shadow-sm">
                    <span><i class="fa-solid fa-terminal mr-2"></i>System Debug</span>
                    <button id="btnCopyLogs" class="text-slate-400 hover:text-white transition-colors p-1" title="Copiar Debug">
                        <i class="fa-regular fa-copy"></i>
                    </button>
                </div>
                <div class="widget-body scrollable !p-2 bg-[#050914]" id="logContainerParent">
                    <div id="systemLogs" class="text-[10px] font-mono whitespace-pre-wrap break-words"></div>
                </div>
            </div>
        </div>

        <!-- Mapa do Brasil -->
        <div class="grid-stack-item" gs-id="p-map" gs-x="3" gs-y="0" gs-w="6" gs-h="5" gs-min-w="4" gs-min-h="4">
            <div class="grid-stack-item-content">
                <div class="panel-header">
                    <span><i class="fa-solid fa-map mr-2"></i>Território Nacional (Clique nos estados)</span>
                </div>
                <div id="mapContainer">
                    <div id="map"></div>
                </div>
            </div>
        </div>

        <!-- Notícias do Estado -->
        <div class="grid-stack-item" gs-id="p-news" gs-x="3" gs-y="5" gs-w="6" gs-h="6" gs-min-w="4" gs-min-h="3">
            <div class="grid-stack-item-content">
                <div class="panel-header">
                    <span><i class="fa-regular fa-newspaper mr-2"></i>Notícias Regionais (Tempo Real)</span>
                    <span id="newsStatus"><i class="fa-solid fa-circle-notch fa-spin text-slate-500"></i></span>
                </div>
                <div id="newsFeed" class="widget-body scrollable !p-0 bg-slate-900/30"></div>
            </div>
        </div>

        <!-- Trânsito & Mobilidade -->
        <div class="grid-stack-item" gs-id="p-traffic" gs-x="9" gs-y="0" gs-w="3" gs-h="4" gs-min-w="2" gs-min-h="3">
            <div class="grid-stack-item-content">
                <div class="panel-header">
                    <span><i class="fa-solid fa-car-side mr-2"></i>Trânsito (Capital)</span>
                </div>
                <div class="widget-body flex flex-col justify-between" id="trafficWidget">
                    <div class="chart-container h-32 shrink-0">
                        <canvas id="trafficChart"></canvas>
                    </div>
                    <div class="text-center mt-2 mb-4">
                        <div id="trafficStatusText" class="text-lg font-bold">Calculando...</div>
                        <div class="text-[10px] text-slate-400 uppercase mt-1">Índice de Lentidão</div>
                    </div>
                    <div class="border-t border-slate-700 pt-3 flex-grow overflow-hidden flex flex-col">
                        <div class="text-[10px] text-slate-400 font-bold uppercase mb-2 shrink-0">Ocorrências (Radar Algorítmico)</div>
                        <div id="trafficIncidents" class="scrollable flex-grow flex flex-col gap-2"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Indicadores Nacionais -->
        <div class="grid-stack-item" gs-id="p-econ" gs-x="9" gs-y="4" gs-w="3" gs-h="3" gs-min-w="2" gs-min-h="3">
            <div class="grid-stack-item-content">
                <div class="panel-header">
                    <span><i class="fa-solid fa-chart-line mr-2"></i>Indicadores Nacionais</span>
                </div>
                <div class="widget-body scrollable flex-col justify-start gap-4" id="marketWidget">
                    <div class="flex justify-between items-center border-b border-slate-700 pb-2">
                        <div>
                            <div class="data-label">Dólar Comercial (USD)</div>
                        </div>
                        <div class="text-right">
                            <div id="usdRate" class="text-xl font-bold font-mono text-green-400">R$ --</div>
                        </div>
                    </div>
                    <div class="flex justify-between items-center border-b border-slate-700 pb-2">
                        <div>
                            <div class="data-label">Euro (EUR)</div>
                        </div>
                        <div class="text-right">
                            <div id="eurRate" class="text-lg font-bold font-mono">R$ --</div>
                        </div>
                    </div>
                    <div class="flex justify-between items-center">
                        <div>
                            <div class="data-label">Taxa Selic (BCB)</div>
                        </div>
                        <div class="text-right">
                            <div id="selicRate" class="text-xl font-bold font-mono text-yellow-400">--%</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Feriados Estaduais/Nacionais -->
        <div class="grid-stack-item" gs-id="p-holidays" gs-x="9" gs-y="7" gs-w="3" gs-h="4" gs-min-w="2" gs-min-h="3">
            <div class="grid-stack-item-content">
                <div class="panel-header">
                    <span><i class="fa-solid fa-calendar-days mr-2"></i>Próximos Feriados</span>
                </div>
                <div class="widget-body scrollable !p-0" id="holidaysWidget">
                    <div class="flex flex-col w-full h-full" id="holidaysList"></div>
                </div>
            </div>
        </div>
        
    </div>

    <!-- Modais -->
    <div id="confirmModal" class="fixed inset-0 z-[100] hidden items-center justify-center modal-overlay">
        <div class="bg-slate-800 border border-slate-600 rounded-lg p-6 max-w-sm w-full shadow-2xl transform scale-95 transition-transform" id="modalBox">
            <h3 class="text-lg font-bold text-white mb-2">Resetar Layout?</h3>
            <p class="text-sm text-slate-300 mb-6">Todos os widgets voltarão ao tamanho e posição originais.</p>
            <div class="flex justify-end gap-3">
                <button id="btnCancelReset" class="px-4 py-2 text-sm font-medium text-slate-300 hover:text-white bg-slate-700 hover:bg-slate-600 rounded transition-colors">Cancelar</button>
                <button id="btnConfirmReset" class="px-4 py-2 text-sm font-medium text-white bg-blue-600 hover:bg-blue-500 rounded transition-colors">Confirmar</button>
            </div>
        </div>
    </div>

    <div id="wikiModal" class="fixed inset-0 z-[100] hidden items-center justify-center modal-overlay">
        <div class="bg-slate-900 border border-slate-600 rounded-lg shadow-2xl w-11/12 max-w-2xl h-[80vh] flex flex-col overflow-hidden transform transition-transform">
            <div class="bg-slate-800 px-4 py-3 flex justify-between items-center border-b border-slate-700">
                <div class="flex items-center gap-2 text-slate-300">
                    <i class="fa-brands fa-wikipedia-w"></i> <span class="text-sm font-bold tracking-wide uppercase">Enciclopédia</span>
                </div>
                <button id="btnCloseWiki" class="text-slate-400 hover:text-white transition-colors"><i class="fa-solid fa-xmark text-xl"></i></button>
            </div>
            <div class="flex-grow bg-white w-full h-full relative">
                <div id="wikiLoader" class="absolute inset-0 flex items-center justify-center bg-slate-100 z-10">
                    <i class="fa-solid fa-circle-notch fa-spin text-3xl text-slate-400"></i>
                </div>
                <iframe id="wikiFrame" class="w-full h-full border-none relative z-20" src=""></iframe>
            </div>
        </div>
    </div>

    <div id="toast" class="fixed bottom-6 right-6 z-[100] toast-enter flex items-center gap-4 bg-slate-800 border border-slate-600 text-white px-4 py-3 rounded shadow-lg pointer-events-none">
        <span class="text-sm font-medium">Layout resetado.</span>
        <button id="btnUndo" class="text-blue-400 hover:text-blue-300 text-sm font-bold pointer-events-auto underline">Desfazer</button>
    </div>

    <script>
        const GamaBrasil = (() => {
            
            // Dicionário offline com Cidades Satélites incluindo "Gama" no DF chumbado
            const BR_STATES = {
                "AC": { name: "Acre", governor: "Gladson Cameli", regiao: "Norte", capital: "Rio Branco", lat: -9.97499, lng: -67.8243, pop: 830018, cities: [] },
                "AL": { name: "Alagoas", governor: "Paulo Dantas", regiao: "Nordeste", capital: "Maceió", lat: -9.66599, lng: -35.735, pop: 3127683, cities: [{name:"Arapiraca", lat:-9.7522, lng:-36.6601}, {name:"Rio Largo", lat:-9.4795, lng:-35.8335}, {name:"Palmeira dos Índios", lat:-9.4071, lng:-36.6268}] },
                "AP": { name: "Amapá", governor: "Clécio Luís", regiao: "Norte", capital: "Macapá", lat: 0.034934, lng: -51.0694, pop: 733759, cities: [] },
                "AM": { name: "Amazonas", governor: "Wilson Lima", regiao: "Norte", capital: "Manaus", lat: -3.10719, lng: -60.0261, pop: 3941613, cities: [{name:"Parintins", lat:-2.6284, lng:-56.7329}, {name:"Itacoatiara", lat:-3.1416, lng:-58.4441}, {name:"Manacapuru", lat:-3.2995, lng:-60.6201}] },
                "BA": { name: "Bahia", governor: "Jerônimo Rodrigues", regiao: "Nordeste", capital: "Salvador", lat: -12.9718, lng: -38.5011, pop: 14141626, cities: [{name:"Feira de Santana", lat:-12.266, lng:-38.966}, {name:"Vitória da Conquista", lat:-14.8661, lng:-40.8394}, {name:"Camaçari", lat:-12.6975, lng:-38.3242}] },
                "CE": { name: "Ceará", governor: "Elmano de Freitas", regiao: "Nordeste", capital: "Fortaleza", lat: -3.71839, lng: -38.5434, pop: 8794957, cities: [{name:"Caucaia", lat:-3.7327, lng:-38.6531}, {name:"Juazeiro do Norte", lat:-7.2104, lng:-39.3155}, {name:"Maracanaú", lat:-3.8767, lng:-38.6256}] },
                "DF": { name: "Distrito Federal", governor: "Ibaneis Rocha", regiao: "Centro-Oeste", capital: "Brasília", lat: -15.7795, lng: -47.9297, pop: 2817381, cities: [{name:"Ceilândia", lat:-15.8208, lng:-48.1132}, {name:"Samambaia", lat:-15.8732, lng:-48.0834}, {name:"Taguatinga", lat:-15.8336, lng:-48.0566}, {name:"Gama", lat:-16.0167, lng:-48.0667}] }, // GAMA chumbado aqui
                "ES": { name: "Espírito Santo", governor: "Renato Casagrande", regiao: "Sudeste", capital: "Vitória", lat: -20.3188, lng: -40.3378, pop: 3833712, cities: [{name:"Serra", lat:-20.1268, lng:-40.3061}, {name:"Vila Velha", lat:-20.3297, lng:-40.2925}, {name:"Cariacica", lat:-20.2638, lng:-40.4201}] },
                "GO": { name: "Goiás", governor: "Ronaldo Caiado", regiao: "Centro-Oeste", capital: "Goiânia", lat: -16.6799, lng: -49.255, pop: 7056495, cities: [{name:"Aparecida de Goiânia", lat:-16.8213, lng:-49.2435}, {name:"Anápolis", lat:-16.3267, lng:-48.9529}, {name:"Rio Verde", lat:-17.7947, lng:-50.9238}] },
                "MA": { name: "Maranhão", governor: "Carlos Brandão", regiao: "Nordeste", capital: "São Luís", lat: -2.5293, lng: -44.3028, pop: 6775805, cities: [{name:"Imperatriz", lat:-5.5152, lng:-47.4722}, {name:"São José de Ribamar", lat:-2.5604, lng:-44.0537}, {name:"Timon", lat:-5.088, lng:-42.8291}] },
                "MT": { name: "Mato Grosso", governor: "Mauro Mendes", regiao: "Centro-Oeste", capital: "Cuiabá", lat: -15.5989, lng: -56.0949, pop: 3658649, cities: [{name:"Várzea Grande", lat:-15.6461, lng:-56.1326}, {name:"Rondonópolis", lat:-16.4716, lng:-54.6368}, {name:"Sinop", lat:-11.8596, lng:-55.5034}] },
                "MS": { name: "Mato Grosso do Sul", governor: "Eduardo Riedel", regiao: "Centro-Oeste", capital: "Campo Grande", lat: -20.4486, lng: -54.6295, pop: 2757013, cities: [{name:"Dourados", lat:-22.2215, lng:-54.8087}, {name:"Três Lagoas", lat:-20.7516, lng:-51.7018}, {name:"Corumbá", lat:-19.009, lng:-57.6533}] },
                "MG": { name: "Minas Gerais", governor: "Romeu Zema", regiao: "Sudeste", capital: "Belo Horizonte", lat: -19.9245, lng: -43.9352, pop: 20538718, cities: [{name:"Uberlândia", lat:-18.9186, lng:-48.2772}, {name:"Contagem", lat:-19.9317, lng:-44.0538}, {name:"Juiz de Fora", lat:-21.7642, lng:-43.3496}] },
                "PA": { name: "Pará", governor: "Helder Barbalho", regiao: "Norte", capital: "Belém", lat: -1.4554, lng: -48.4898, pop: 8121025, cities: [{name:"Ananindeua", lat:-1.3656, lng:-48.3752}, {name:"Santarém", lat:-2.4431, lng:-54.7082}, {name:"Marabá", lat:-5.3686, lng:-49.1189}] },
                "PB": { name: "Paraíba", governor: "João Azevêdo", regiao: "Nordeste", capital: "João Pessoa", lat: -7.11532, lng: -34.861, pop: 3974687, cities: [{name:"Campina Grande", lat:-7.2289, lng:-35.8812}, {name:"Santa Rita", lat:-7.1147, lng:-34.978}, {name:"Patos", lat:-7.0261, lng:-37.2758}] },
                "PR": { name: "Paraná", governor: "Ratinho Júnior", regiao: "Sul", capital: "Curitiba", lat: -25.429, lng: -49.2671, pop: 11444380, cities: [{name:"Londrina", lat:-23.3103, lng:-51.1628}, {name:"Maringá", lat:-23.421, lng:-51.9331}, {name:"Ponta Grossa", lat:-25.0916, lng:-50.1668}] },
                "PE": { name: "Pernambuco", governor: "Raquel Lyra", regiao: "Nordeste", capital: "Recife", lat: -8.04756, lng: -34.877, pop: 9058931, cities: [{name:"Jaboatão dos Guararapes", lat:-8.1139, lng:-35.0153}, {name:"Olinda", lat:-8.0089, lng:-34.8553}, {name:"Caruaru", lat:-8.2833, lng:-35.9761}] },
                "PI": { name: "Piauí", governor: "Rafael Fonteles", regiao: "Nordeste", capital: "Teresina", lat: -5.08921, lng: -42.8016, pop: 3271199, cities: [{name:"Parnaíba", lat:-2.9038, lng:-41.7774}, {name:"Picos", lat:-7.085, lng:-41.4667}, {name:"Piripiri", lat:-4.2754, lng:-41.7765}] },
                "RJ": { name: "Rio de Janeiro", governor: "Cláudio Castro", regiao: "Sudeste", capital: "Rio de Janeiro", lat: -22.9035, lng: -43.2096, pop: 16054524, cities: [{name:"São Gonçalo", lat:-22.8269, lng:-43.0539}, {name:"Duque de Caxias", lat:-22.7856, lng:-43.3117}, {name:"Nova Iguaçu", lat:-22.7561, lng:-43.4607}] },
                "RN": { name: "Rio Grande do Norte", governor: "Fátima Bezerra", regiao: "Nordeste", capital: "Natal", lat: -5.795, lng: -35.2094, pop: 3302729, cities: [{name:"Mossoró", lat:-5.1878, lng:-37.3411}, {name:"Parnamirim", lat:-5.9149, lng:-35.2625}, {name:"São Gonçalo do Amarante", lat:-5.7938, lng:-35.3283}] },
                "RS": { name: "Rio Grande do Sul", governor: "Eduardo Leite", regiao: "Sul", capital: "Porto Alegre", lat: -30.0331, lng: -51.23, pop: 10882965, cities: [{name:"Caxias do Sul", lat:-29.1683, lng:-51.1794}, {name:"Pelotas", lat:-31.7719, lng:-52.3425}, {name:"Canoas", lat:-29.9174, lng:-51.1837}] },
                "RO": { name: "Rondônia", governor: "Marcos Rocha", regiao: "Norte", capital: "Porto Velho", lat: -8.76116, lng: -63.9004, pop: 1581196, cities: [{name:"Ji-Paraná", lat:-10.8807, lng:-61.9443}, {name:"Ariquemes", lat:-9.9057, lng:-63.0332}, {name:"Vilhena", lat:-12.7404, lng:-60.1458}] },
                "RR": { name: "Roraima", governor: "Antonio Denarium", regiao: "Norte", capital: "Boa Vista", lat: 2.8235, lng: -60.6758, pop: 636269, cities: [] },
                "SC": { name: "Santa Catarina", governor: "Jorginho Mello", regiao: "Sul", capital: "Florianópolis", lat: -27.5969, lng: -48.5495, pop: 7610361, cities: [{name:"Joinville", lat:-26.3045, lng:-48.8487}, {name:"Blumenau", lat:-26.9194, lng:-49.0661}, {name:"São José", lat:-27.6136, lng:-48.627}] },
                "SP": { name: "São Paulo", governor: "Tarcísio de Freitas", regiao: "Sudeste", capital: "São Paulo", lat: -23.5505, lng: -46.6333, pop: 44411238, cities: [{name:"Guarulhos", lat:-23.4628, lng:-46.5333}, {name:"Campinas", lat:-22.9099, lng:-47.0626}, {name:"São Bernardo do Campo", lat:-23.6939, lng:-46.565}] },
                "SE": { name: "Sergipe", governor: "Fábio Mitidieri", regiao: "Nordeste", capital: "Aracaju", lat: -10.9472, lng: -37.0731, pop: 2209558, cities: [{name:"Nossa Senhora do Socorro", lat:-10.8542, lng:-37.1264}, {name:"Lagarto", lat:-10.915, lng:-37.6681}, {name:"Itabaiana", lat:-10.6861, lng:-37.4261}] },
                "TO": { name: "Tocantins", governor: "Wanderlei Barbosa", regiao: "Norte", capital: "Palmas", lat: -10.1675, lng: -48.3277, pop: 1511460, cities: [{name:"Araguaína", lat:-7.1911, lng:-48.2072}, {name:"Gurupi", lat:-11.7292, lng:-49.0686}, {name:"Porto Nacional", lat:-10.7081, lng:-48.4172}] }
            };

            // Cores mais fortes para dar contraste apenas nas bordas do mapa claro
            const REGION_COLORS = {
                'Norte': '#16a34a',      // Verde Forte
                'Nordeste': '#eab308',   // Amarelo/Ouro
                'Centro-Oeste': '#db2777', // Rosa/Magenta Forte
                'Sudeste': '#2563eb',    // Azul Forte
                'Sul': '#7c3aed'         // Roxo Forte
            };

            const State = {
                currentState: null, grid: null, map: null, geoJsonLayer: null, markers: [],
                defaultLayout: [], previousLayout: null, trafficChart: null,
                clockInterval: null,
                intervals: { news: null, general: null }
            };

            const Logger = {
                container: document.getElementById('systemLogs'), parent: document.getElementById('logContainerParent'), rawLogs: [],
                add(level, module, message, details = null) {
                    const now = new Date(); const timeStr = now.toLocaleTimeString('pt-BR', { hour12: false }) + '.' + String(now.getMilliseconds()).padStart(3, '0');
                    let color = 'text-slate-300'; let icon = 'INFO';
                    if (level === 'ERROR') { color = 'text-red-400 font-bold'; icon = 'FAIL'; }
                    else if (level === 'WARN') { color = 'text-yellow-400'; icon = 'WARN'; }
                    else if (level === 'OK') { color = 'text-green-400'; icon = ' OK '; }

                    const logString = `[${timeStr}] [${icon}] [${module}] ${message}`;
                    this.rawLogs.push(logString + (details ? ' -> ' + JSON.stringify(details) : ''));

                    if(this.container) {
                        const div = document.createElement('div'); div.className = `log-entry ${color}`;
                        div.innerHTML = `<span class="log-time">[${timeStr}]</span> <span class="${level === 'ERROR' ? 'text-red-500' : 'text-slate-500'} font-bold">[${icon}]</span> <span class="log-module">[${module}]</span> ${message}`;
                        if (details) { const detDiv = document.createElement('div'); detDiv.className = 'text-[9px] text-slate-500 ml-4 mt-0.5'; detDiv.innerText = typeof details === 'object' ? JSON.stringify(details) : details; div.appendChild(detDiv); }
                        this.container.appendChild(div);
                        if(this.parent) this.parent.scrollTop = this.parent.scrollHeight;
                        if (this.container.children.length > 50) this.container.removeChild(this.container.firstChild);
                    }
                },
                init() {
                    const btn = document.getElementById('btnCopyLogs');
                    if(btn) { btn.addEventListener('click', (e) => { e.preventDefault(); navigator.clipboard.writeText(this.rawLogs.join('\n')).then(() => { btn.innerHTML = '<i class="fa-solid fa-check text-green-500"></i>'; setTimeout(() => { btn.innerHTML = '<i class="fa-regular fa-copy"></i>'; }, 2000); }); }); }
                    this.add('INFO', 'SYSTEM', 'Inicializando Gama Brasil...');
                }
            };

            const UI = {
                get selector() { return document.getElementById('stateSelector'); },
                get clock() { return document.getElementById('localClock'); },
                get newsFeed() { return document.getElementById('newsFeed'); },
                get flag() { return document.getElementById('flagImg'); },
                get name() { return document.getElementById('stateName'); },
                get capital() { return document.getElementById('stateCapital'); },
                get population() { return document.getElementById('population'); },
                get governor() { return document.getElementById('governorName'); },
                get ufCode() { return document.getElementById('ufCode'); },
                get root() { return document.documentElement; },
                
                showLoading(containerId, message = "Carregando...") { const el = document.getElementById(containerId); if(el) el.innerHTML = `<div class="error-state"><i class="fa-solid fa-circle-notch fa-spin text-2xl text-[var(--theme-secondary)]"></i><span class="mt-2 text-xs font-mono uppercase tracking-wider">${message}</span></div>`; },
                showError(containerId, message = "Indisponível") { const el = document.getElementById(containerId); if(el) el.innerHTML = `<div class="error-state"><i class="fa-solid fa-circle-exclamation text-2xl text-red-400"></i><span class="mt-2 text-xs font-mono uppercase tracking-wider">${message}</span></div>`; },
                applyTheme(primary, secondary) { this.root.style.setProperty('--theme-primary', primary); this.root.style.setProperty('--theme-secondary', secondary); }
            };

            const WikiManager = {
                init() {
                    document.getElementById('btnCloseWiki').addEventListener('click', () => { document.getElementById('wikiModal').classList.add('hidden'); document.getElementById('wikiFrame').src = ''; });
                    document.getElementById('wikiFrame').addEventListener('load', () => document.getElementById('wikiLoader').classList.add('hidden'));
                    const bindLink = (elementId) => { const el = document.getElementById(elementId); if(!el) return; el.addEventListener('click', () => { let term = el.textContent.trim(); if(term === '--' || term === 'Buscando...') return; this.openModal(term); }); };
                    bindLink('stateName'); bindLink('stateCapital'); bindLink('governorName');
                },
                openModal(term) {
                    Logger.add('INFO', 'WIKI', `Abrindo artigo`, term);
                    document.getElementById('wikiModal').classList.remove('hidden'); document.getElementById('wikiLoader').classList.remove('hidden');
                    document.getElementById('wikiFrame').src = `https://pt.m.wikipedia.org/wiki/${encodeURIComponent(term)}`;
                }
            };

            const ColorEngine = {
                getLuminance(r, g, b) { const a = [r, g, b].map(v => { v /= 255; return v <= 0.03928 ? v / 12.92 : Math.pow((v + 0.055) / 1.055, 2.4); }); return a[0] * 0.2126 + a[1] * 0.7152 + a[2] * 0.0722; },
                rgbToHex(r, g, b) { return "#" + (1 << 24 | r << 16 | g << 8 | b).toString(16).slice(1); },
                extract(imgEl) {
                    try {
                        const canvas = document.createElement('canvas'); const ctx = canvas.getContext('2d', { willReadFrequently: true });
                        canvas.width = imgEl.width || 100; canvas.height = imgEl.height || 100; ctx.drawImage(imgEl, 0, 0, canvas.width, canvas.height);
                        const data = ctx.getImageData(0, 0, canvas.width, canvas.height).data; const colorCounts = {};
                        for (let i = 0; i < data.length; i += 16) { 
                            const r = Math.round(data[i] / 24) * 24; const g = Math.round(data[i+1] / 24) * 24; const b = Math.round(data[i+2] / 24) * 24;
                            if(data[i+3] < 128) continue; colorCounts[`${r},${g},${b}`] = (colorCounts[`${r},${g},${b}`] || 0) + 1;
                        }
                        let paletteRGB = Object.entries(colorCounts).sort((a, b) => b[1] - a[1]).slice(0, 6).map(e => e[0].split(',').map(Number));
                        if(paletteRGB.length === 0) throw new Error("Sem cores");
                        const bgLum = this.getLuminance(30, 41, 59);
                        let primary = paletteRGB[0]; let secondary = paletteRGB.length > 1 ? paletteRGB[1] : primary;
                        if(this.getLuminance(...primary) < bgLum + 0.1) primary = [16, 185, 129];
                        if(this.getLuminance(...secondary) < bgLum + 0.1) secondary = [250, 204, 21];
                        UI.applyTheme(this.rgbToHex(...primary), this.rgbToHex(...secondary));
                        Logger.add('OK', 'THEME', `Cores extraídas da bandeira`);
                    } catch (e) {
                        Logger.add('WARN', 'THEME', `Usando padrão verde/amarelo`, e.message);
                        UI.applyTheme('#10b981', '#facc15');
                    }
                }
            };

            const API = {
                async fetch(url, options = {}, retries = 2) {
                    for (let i = 0; i < retries; i++) {
                        try { const res = await fetch(url, options); if (!res.ok) throw new Error(`HTTP ${res.status}`); return await res.json(); } 
                        catch (err) { if (i === retries - 1) return null; await new Promise(r => setTimeout(r, 1000)); }
                    }
                },
                async fetchXML(url) {
                    try { 
                        const res = await fetch(`https://api.allorigins.win/get?url=${encodeURIComponent(url)}`);
                        if (!res.ok) throw new Error(`Proxy HTTP ${res.status}`);
                        const data = await res.json();
                        return new DOMParser().parseFromString(data.contents, "text/xml");
                    } catch (err) { Logger.add('ERROR', 'API_XML', `Falha RSS`, err.message); return null; }
                }
            };

            const VisEngine = {
                initGrid() {
                    State.grid = GridStack.init({ cellHeight: 80, margin: 12, handle: '.panel-header', float: true });
                    State.defaultLayout = State.grid.save();
                    const saved = localStorage.getItem('gama_br_layout'); 
                    if (saved) { try { State.grid.load(JSON.parse(saved)); } catch(e){} }
                    const saveState = () => localStorage.setItem('gama_br_layout', JSON.stringify(State.grid.save().map(n => ({x: n.x, y: n.y, w: n.w, h: n.h, id: n.id}))));
                    State.grid.on('change', saveState); State.grid.on('dragstop', saveState); 
                    State.grid.on('resizestop', () => { saveState(); if (State.map) setTimeout(() => State.map.invalidateSize(), 100); if (State.trafficChart) State.trafficChart.resize(); });
                },
                initMap() {
                    State.map = L.map('map', { zoomControl: false, maxBounds: [[-35, -75], [10, -30]], minZoom: 3 }).setView([-15, -55], 4);
                    
                    // Mapa Claro e Colorido (OpenStreetMap)
                    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { 
                        attribution: '&copy; OpenStreetMap' 
                    }).addTo(State.map);
                    
                    API.fetch('https://raw.githubusercontent.com/codeforamerica/click_that_hood/master/public/data/brazil-states.geojson').then(data => {
                        if(data) {
                            State.geoJsonLayer = L.geoJSON(data, {
                                style: (feature) => {
                                    const sigla = feature.properties.sigla;
                                    const regionInfo = BR_STATES[sigla]?.regiao || 'Sul';
                                    return { 
                                        color: REGION_COLORS[regionInfo], 
                                        weight: 2, 
                                        fillColor: REGION_COLORS[regionInfo], 
                                        fillOpacity: 0.05, // Retirando a máscara de preenchimento 
                                        className: 'state-polygon'
                                    };
                                },
                                onEachFeature: (feature, layer) => {
                                    layer.on('click', () => {
                                        const sigla = feature.properties.sigla;
                                        if (UI.selector.value !== sigla) {
                                            UI.selector.value = sigla;
                                            DataEngine.changeState(sigla);
                                        }
                                    });
                                }
                            }).addTo(State.map);
                            this.highlightState(State.currentState.uf);
                        }
                    });
                },
                highlightState(uf) {
                    if(!State.geoJsonLayer || !State.map) return;
                    
                    // Remove marcadores antigos de cidades
                    State.markers.forEach(m => State.map.removeLayer(m));
                    State.markers = [];

                    const s = BR_STATES[uf];

                    State.geoJsonLayer.eachLayer(layer => {
                        const layerUf = layer.feature.properties.sigla;
                        const regionInfo = BR_STATES[layerUf]?.regiao || 'Sul';
                        
                        if(layerUf === uf) {
                            // Contorno forte com cor tema para o selecionado
                            layer.setStyle({ 
                                color: 'var(--theme-primary)', 
                                weight: 4, 
                                fillColor: 'var(--theme-primary)', 
                                fillOpacity: 0.15 
                            });
                            State.map.flyToBounds(layer.getBounds(), { padding: [20,20], duration: 1.5 });
                        } else {
                            // Contorno da região fino para os não selecionados, zero preenchimento
                            layer.setStyle({ 
                                color: REGION_COLORS[regionInfo], 
                                weight: 2, 
                                fillColor: REGION_COLORS[regionInfo], 
                                fillOpacity: 0.05 
                            });
                        }
                    });

                    // Adiciona marcador da capital
                    const capIcon = L.divIcon({ 
                        className: 'custom-pin', 
                        html: `<div style="background: var(--theme-primary); border: 2px solid #fff; border-radius: 50%; width: 16px; height: 16px; box-shadow: 0 0 10px rgba(0,0,0,0.5);"></div><div style="color:#000; background:rgba(255,255,255,0.9); padding: 2px 4px; border-radius:3px; font-weight:bold; font-size:10px; margin-top:2px; white-space:nowrap;">★ ${s.capital}</div>`, 
                        iconSize: [20, 20], iconAnchor: [10, 10] 
                    });
                    State.markers.push(L.marker([s.lat, s.lng], {icon: capIcon}).addTo(State.map));

                    // Adiciona marcadores das cidades satélites (Acima de 1M hab. Pop DF é 2.8M)
                    if (s.pop > 1000000 && s.cities && s.cities.length > 0) {
                        s.cities.forEach(city => {
                            const cityIcon = L.divIcon({ 
                                className: 'custom-pin', 
                                html: `<div style="background: var(--theme-secondary); border: 1px solid #fff; border-radius: 50%; width: 10px; height: 10px;"></div><div style="color:#000; background:rgba(255,255,255,0.8); padding: 1px 3px; border-radius:2px; font-weight:600; font-size:9px; margin-top:2px; white-space:nowrap;">${city.name}</div>`, 
                                iconSize: [10, 10], iconAnchor: [5, 5] 
                            });
                            State.markers.push(L.marker([city.lat, city.lng], {icon: cityIcon}).addTo(State.map));
                        });
                    }
                },
                renderTrafficChart(level) { 
                    const ctx = document.getElementById('trafficChart'); if(!ctx) return;
                    if (State.trafficChart) State.trafficChart.destroy();
                    
                    Chart.defaults.color = '#94a3b8'; Chart.defaults.font.family = "'Inter', sans-serif";
                    
                    let color = '#10b981'; let text = 'TRÂNSITO LIVRE';
                    if(level > 4) { color = '#facc15'; text = 'MODERADO / LENTIDÃO'; }
                    if(level > 7) { color = '#ef4444'; text = 'TRÂNSITO INTENSO'; }
                    
                    document.getElementById('trafficStatusText').innerText = text;
                    document.getElementById('trafficStatusText').style.color = color;

                    State.trafficChart = new Chart(ctx, {
                        type: 'doughnut',
                        data: { datasets: [{ data: [level, 10 - level], backgroundColor: [color, '#1e293b'], borderWidth: 0 }] },
                        options: { 
                            responsive: true, maintainAspectRatio: false, circumference: 180, rotation: 270, cutout: '80%',
                            plugins: { tooltip: {enabled: false}, legend: {display: false} }
                        }
                    });
                }
            };

            const DataEngine = {
                initStates() {
                    Object.keys(BR_STATES).sort().forEach(uf => {
                        const opt = document.createElement('option'); opt.value = uf; opt.text = BR_STATES[uf].name;
                        if(UI.selector) UI.selector.appendChild(opt);
                    });
                    const savedUf = localStorage.getItem('gama_br_uf') || 'SP';
                    if(UI.selector) UI.selector.value = savedUf;
                    this.changeState(savedUf);
                },
                async changeState(uf) {
                    Logger.add('INFO', 'SYSTEM', `=== MUDANDO PARA [${uf}] ===`);
                    localStorage.setItem('gama_br_uf', uf);
                    
                    const s = BR_STATES[uf]; 
                    State.currentState = { uf: uf, ...s };

                    if(UI.name) UI.name.innerText = s.name; 
                    if(UI.capital) UI.capital.innerText = s.capital; // Sem a palavra "Capital:" para não quebrar a Wiki
                    if(UI.population) UI.population.innerText = s.pop.toLocaleString('pt-BR'); 
                    if(UI.ufCode) UI.ufCode.innerText = uf;
                    
                    if(UI.flag) {
                        UI.flag.src = `https://raw.githubusercontent.com/bgeneto/bandeiras-br/master/imagens/${uf}.png`; 
                        UI.flag.classList.remove('hidden');
                        UI.flag.onload = () => ColorEngine.extract(UI.flag);
                    }

                    if(UI.governor) UI.governor.innerText = s.governor;

                    VisEngine.highlightState(uf);
                    this.setupClock();
                    this.fetchHolidays();
                    this.fetchNews(s.name);
                    
                    this.executeGeneralFetch(s.capital, [s.lat, s.lng]);

                    if(State.intervals.news) clearInterval(State.intervals.news);
                    if(State.intervals.general) clearInterval(State.intervals.general);
                    State.intervals.news = setInterval(() => this.fetchNews(s.name), 120000); 
                    State.intervals.general = setInterval(() => this.executeGeneralFetch(s.capital, [s.lat, s.lng]), 1800000);
                },

                executeGeneralFetch(capitalName, latlng) {
                    this.fetchMarketData();
                    this.fetchWeatherAndTraffic(latlng);
                },

                setupClock() {
                    if(State.clockInterval) clearInterval(State.clockInterval);
                    State.clockInterval = setInterval(() => {
                        let offsetH = -3;
                        const uf = State.currentState.uf;
                        if(['AM','MT','MS','RO','RR'].includes(uf)) offsetH = -4;
                        if(uf === 'AC') offsetH = -5;
                        
                        const now = new Date(); 
                        const utc = now.getTime() + (now.getTimezoneOffset() * 60000);
                        const localTime = new Date(utc + (3600000 * offsetH));
                        
                        if(UI.clock) UI.clock.innerText = localTime.toLocaleTimeString('pt-BR', {hour12: false});
                        document.getElementById('timezoneLabel').innerText = `UTC${offsetH}:00`;
                    }, 1000);
                },

                async fetchMarketData() {
                    API.fetch('https://open.er-api.com/v6/latest/USD').then(data => { 
                        if(data?.rates?.BRL) {
                            document.getElementById('usdRate').innerText = `R$ ${data.rates.BRL.toFixed(2)}`;
                            const eurBrl = data.rates.BRL / data.rates.EUR;
                            document.getElementById('eurRate').innerText = `R$ ${eurBrl.toFixed(2)}`;
                        }
                    });
                    API.fetch('https://api.bcb.gov.br/dados/serie/bcdata.sgs.432/dados/ultimos/1').then(data => {
                        if(data && data[0]) document.getElementById('selicRate').innerText = `${data[0].valor}%`;
                    });
                },

                async fetchWeatherAndTraffic(latlng) {
                    const wBox = document.getElementById('climateWidget');
                    UI.showLoading('climateWidget', 'Satélite...');
                    const data = await API.fetch(`https://api.open-meteo.com/v1/forecast?latitude=${latlng[0]}&longitude=${latlng[1]}&current_weather=true`);
                    
                    let isRaining = false;
                    
                    if(data?.current_weather) {
                        const w = data.current_weather; const wmo = w.weathercode; 
                        let icon = 'fa-cloud', desc = 'Nublado';
                        if(wmo === 0) { icon = 'fa-sun'; desc = 'Céu Limpo'; } 
                        else if(wmo > 0 && wmo < 4) { icon = 'fa-cloud-sun'; desc = 'Parc. Nublado'; } 
                        else if(wmo >= 51 && wmo <= 67) { icon = 'fa-cloud-rain'; desc = 'Chuva'; isRaining = true; } 
                        else if(wmo >= 95) { icon = 'fa-bolt'; desc = 'Tempestade'; isRaining = true; }
                        
                        if(wBox) wBox.innerHTML = `<div class="flex flex-col items-center text-center gap-2"><div class="text-5xl" id="weatherIcon"><i class="fa-solid ${icon}" style="color: var(--theme-secondary)"></i></div><div id="temperature" class="text-4xl font-bold tracking-tighter mt-2">${w.temperature}°C</div><div id="weatherDesc" class="text-sm text-slate-400 capitalize">${desc}</div></div>`;
                    }
                    
                    this.simulateTraffic(isRaining);
                },
                
                simulateTraffic(isRaining) {
                    const now = new Date(); const hour = now.getHours();
                    let baseLevel = 2; 
                    if (hour >= 6 && hour < 9) baseLevel = 7;
                    else if (hour >= 9 && hour < 16) baseLevel = 4;
                    else if (hour >= 16 && hour < 20) baseLevel = 8;
                    else if (hour >= 20 && hour < 23) baseLevel = 3; 
                    
                    let randomMod = Math.floor(Math.random() * 3) - 1; 
                    if(isRaining) baseLevel += 2; 
                    
                    let finalLevel = Math.max(0, Math.min(10, baseLevel + randomMod));
                    VisEngine.renderTrafficChart(finalLevel);
                    
                    const incContainer = document.getElementById('trafficIncidents');
                    incContainer.innerHTML = '';
                    
                    const incidentsDB = [
                        { t: 'Acidente leve', c: 'fa-car-burst', cor: 'text-red-400' },
                        { t: 'Semáforo inoperante', c: 'fa-traffic-light', cor: 'text-yellow-400' },
                        { t: 'Obras na via', c: 'fa-person-digging', cor: 'text-orange-400' },
                        { t: 'Pista escorregadia', c: 'fa-droplet', cor: 'text-blue-400' },
                        { t: 'Veículo quebrado', c: 'fa-triangle-exclamation', cor: 'text-yellow-500' }
                    ];
                    
                    let numInc = finalLevel < 3 ? 0 : (finalLevel < 7 ? 1 : 2);
                    if(numInc === 0) {
                        incContainer.innerHTML = '<div class="text-xs text-slate-500 text-center mt-4">Nenhuma ocorrência grave reportada.</div>';
                    } else {
                        for(let i=0; i<numInc; i++) {
                            const ev = incidentsDB[Math.floor(Math.random()*incidentsDB.length)];
                            const div = document.createElement('div');
                            div.className = 'flex items-center gap-3 p-2 bg-slate-800/40 rounded border border-slate-700/50';
                            div.innerHTML = `<i class="fa-solid ${ev.c} ${ev.cor}"></i><div class="text-[11px] font-medium">${ev.t} (Capital)</div>`;
                            incContainer.appendChild(div);
                        }
                    }
                },

                async fetchNews(stateName) {
                    if(UI.newsStatus) UI.newsStatus.innerHTML = '<i class="fa-solid fa-circle-notch fa-spin text-slate-500"></i>';
                    UI.showLoading('newsFeed', 'Buscando imprensa local...');
                    
                    let query = encodeURIComponent(`"${stateName}" Brasil`);
                    const rssUrl = `https://news.google.com/rss/search?q=${query}&hl=pt-BR&gl=BR&ceid=BR:pt-419`;
                    
                    const xmlDoc = await API.fetchXML(rssUrl);
                    if(UI.newsFeed) UI.newsFeed.innerHTML = ''; 

                    if(xmlDoc) {
                        const items = xmlDoc.querySelectorAll("item");
                        if(items.length > 0) {
                            Array.from(items).slice(0, 15).forEach(item => {
                                const titleEl = item.querySelector("title"); const linkEl = item.querySelector("link"); 
                                const pubDateEl = item.querySelector("pubDate"); const sourceEl = item.querySelector("source");
                                const rawTitle = titleEl ? titleEl.textContent : ''; const link = linkEl ? linkEl.textContent : '#';
                                const pubDate = pubDateEl ? new Date(pubDateEl.textContent).toLocaleDateString('pt-BR') : '';
                                const source = sourceEl ? sourceEl.textContent : 'Imprensa';
                                let cleanTitle = rawTitle; const splitIdx = cleanTitle.lastIndexOf(' - '); if(splitIdx > 0) cleanTitle = cleanTitle.substring(0, splitIdx);

                                const div = document.createElement('a'); div.href = link; div.target = "_blank";
                                div.className = 'block border-l-4 border-transparent hover:border-[var(--theme-primary)] hover:bg-slate-800/50 p-3 border-b border-slate-800 transition-all shrink-0 cursor-pointer group';
                                div.innerHTML = `<div class="flex justify-between items-center text-[10px] text-slate-400 mb-1 font-mono"><span class="text-[var(--theme-secondary)] font-bold uppercase tracking-wider">${source}</span><span>${pubDate}</span></div><div class="text-slate-200 text-sm font-medium leading-tight group-hover:text-white transition-colors">${cleanTitle}</div>`;
                                UI.newsFeed.appendChild(div);
                            });
                            if(UI.newsStatus) UI.newsStatus.innerHTML = '<i class="fa-solid fa-check text-green-500"></i>';
                        } else { UI.showError('newsFeed', 'Nenhuma notícia.'); }
                    } else { UI.showError('newsFeed', 'Falha no feed RSS.'); }
                },

                async fetchHolidays() {
                    UI.showLoading('holidaysList', 'Buscando feriados...');
                    const listEl = document.getElementById('holidaysList');
                    const data = await API.fetch(`https://date.nager.at/api/v3/NextPublicHolidays/BR`);
                    
                    if(listEl) listEl.innerHTML = '';
                    if(data && data.length > 0) {
                        data.slice(0, 4).forEach(h => {
                            const dateObj = new Date(h.date); const dateStr = dateObj.toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit' });
                            const div = document.createElement('div'); div.className = 'flex items-center px-4 py-3 border-b border-slate-700/50 hover:bg-slate-800/30 transition-colors shrink-0';
                            div.innerHTML = `<div class="bg-slate-900 border border-slate-600 border-l-4 border-l-[var(--theme-secondary)] text-slate-200 font-mono font-bold text-[11px] px-2 py-1 rounded mr-3 shadow shrink-0">${dateStr}</div><div class="flex flex-col overflow-hidden"><span class="text-sm font-bold text-slate-200 truncate">${h.localName}</span><span class="text-[10px] text-slate-400 truncate">Feriado Nacional</span></div>`;
                            listEl.appendChild(div);
                        });
                    } else { UI.showError('holidaysWidget', 'Sem dados'); }
                }
            };

            const LayoutEngine = {
                init() {
                    const modal = document.getElementById('confirmModal'); const modalBox = document.getElementById('modalBox'); const toast = document.getElementById('toast');
                    const toggleModal = (show) => { if(show) { modal.classList.remove('hidden'); modal.classList.add('flex'); setTimeout(() => modalBox.classList.remove('scale-95'), 10); } else { modalBox.classList.add('scale-95'); setTimeout(() => { modal.classList.add('hidden'); modal.classList.remove('flex'); }, 200); } };
                    
                    document.getElementById('resetLayoutBtn').addEventListener('click', () => toggleModal(true));
                    document.getElementById('btnCancelReset').addEventListener('click', () => toggleModal(false));
                    document.getElementById('btnConfirmReset').addEventListener('click', () => {
                        toggleModal(false); State.previousLayout = State.grid.save().map(n => ({x: n.x, y: n.y, w: n.w, h: n.h, id: n.id})); 
                        localStorage.removeItem('gama_br_layout'); State.grid.load(State.defaultLayout);
                        setTimeout(() => { if (State.map) State.map.invalidateSize(); if (State.trafficChart) State.trafficChart.resize(); }, 300);
                        if(toast) { toast.classList.replace('toast-enter', 'toast-active'); setTimeout(() => toast.classList.replace('toast-active', 'toast-enter'), 5000); }
                    });

                    document.getElementById('btnUndo').addEventListener('click', () => {
                        if(State.previousLayout) { State.grid.load(State.previousLayout); localStorage.setItem('gama_br_layout', JSON.stringify(State.previousLayout)); setTimeout(() => { if (State.map) State.map.invalidateSize(); if (State.trafficChart) State.trafficChart.resize(); }, 300); }
                        if(toast) toast.classList.replace('toast-active', 'toast-enter');
                    });
                }
            };

            return {
                init() {
                    Logger.init(); 
                    VisEngine.initGrid();
                    VisEngine.initMap();
                    LayoutEngine.init();
                    WikiManager.init();
                    if(UI.selector) UI.selector.addEventListener('change', (e) => DataEngine.changeState(e.target.value));
                    DataEngine.initStates();
                }
            };

        })();

        window.addEventListener('DOMContentLoaded', GamaBrasil.init);
    </script>
</body>
</html>